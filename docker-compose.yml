services:
  # PostgreSQL: general-purpose storage for articles, images, and web cache.
  # The old aichat-rssfeed and aichat-fetch services have been removed;
  # all web content is now fetched via the human_browser container (a12fdfeaaf78)
  # and persisted here.
  aichat-db:
    image: postgres:16
    environment:
      POSTGRES_DB: aichat
      POSTGRES_USER: aichat
      POSTGRES_PASSWORD: aichat
    volumes:
      - aichatdb:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aichat -d aichat"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI service that wraps the PostgreSQL DB with REST endpoints for
  # storing/searching articles, images, and cached web pages.
  aichat-database:
    build: ./docker/database
    environment:
      DATABASE_URL: postgresql://aichat:aichat@aichat-db:5432/aichat
    depends_on:
      - aichat-db
    ports:
      - "8091:8091"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8091/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # RSS/feed discovery (returns feed URLs; stores articles via aichat-database).
  aichat-researchbox:
    build: ./docker/researchbox
    tty: true
    stdin_open: true
    environment:
      DATABASE_URL: http://aichat-database:8091
    volumes:
      - /tmp/research:/tmp/research
    ports:
      - "8092:8092"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8092/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # MCP HTTP/SSE server — exposes all aichat tools to LM Studio and other
  # MCP clients over the network.  Reachable at http://<host-ip>:8096/sse
  aichat-mcp:
    build: ./docker/mcp
    environment:
      DATABASE_URL: http://aichat-database:8091
      MEMORY_URL:   http://aichat-memory:8094
      RESEARCH_URL: http://aichat-researchbox:8092
      TOOLKIT_URL:  http://aichat-toolkit:8095
      # human_browser is connected to this network by the install script
      # so it is reachable by hostname from within the container.
      BROWSER_URL:  http://human_browser:7081
      # Image generation — points at LM Studio (or any OpenAI-compatible image API).
      # Set IMAGE_GEN_MODEL to the exact model name shown in LM Studio to pin a model.
      IMAGE_GEN_BASE_URL: http://host.docker.internal:1234
      IMAGE_GEN_MODEL: ""
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # Read/write the browser screenshot workspace — rw allows saving pipeline outputs
      - /docker/human_browser/workspace:/browser-workspace
    depends_on:
      - aichat-database
      - aichat-memory
      - aichat-researchbox
    ports:
      - "8096:8096"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8096/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  aichat-memory:
    build: ./docker/memory
    environment:
      DATABASE_URL: http://aichat-database:8091
    depends_on:
      - aichat-database
    ports:
      - "8094:8094"
    volumes:
      - memorydb:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8094/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  aichat-toolkit:
    build: ./docker/toolkit
    environment:
      DATABASE_URL: http://aichat-database:8091
    depends_on:
      - aichat-database
    ports:
      - "8095:8095"
    volumes:
      - ${HOME}/.config/aichat/tools:/data/tools
      - ${HOME}/git:/data/repos:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8095/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  # WhatsApp bot — Baileys + LM Studio with full MCP tool support.
  # Visit http://localhost:8097 to scan the QR code and pair a number.
  aichat-whatsapp:
    build: ./docker/whatsapp
    environment:
      LM_STUDIO_URL: http://host.docker.internal:1234
      MCP_URL:       http://aichat-mcp:8096
      MEMORY_URL:    http://aichat-memory:8094
      BOT_NAME:      AI Assistant
      MAX_HISTORY:   "20"
      MAX_TOOL_ITER: "5"
      MAX_TOKENS:    "1024"
      ALLOW_GROUPS:  "false"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - aichat-memory
      - aichat-mcp
      - aichat-toolkit
    ports:
      - "8097:8097"
    volumes:
      - whatsappauth:/data/auth
    restart: unless-stopped

volumes:
  aichatdb:
  memorydb:
  whatsappauth:
